{% extends "layout.html" %}

{% block content %}

<head>
    <!-- MathJaxの読み込み -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .input-form {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            border-color: #2196F3;
            outline: none;
        }

        .submit-button {
            background: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .submit-button:hover {
            background: #1976D2;
        }

        .preview-area {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background: #f5f5f5;
            min-height: 100px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .op-button {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .op-button:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .message-history {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>関数電卓</h1>
        
        <div class="input-form">
            <form method="POST">
                <input type="text" 
                       name="user_message" 
                       id="user_message" 
                       class="input-field"
                       placeholder="ここにLaTeX形式で数式を入力">
                <button type="submit" class="submit-button">送信</button>
            </form>
        </div>

        <h2>数式プレビュー</h2>
        <div id="preview" class="preview-area"></div>

        <div id="button-container" class="button-grid">
            <!-- ボタンはJavaScriptで挿入 -->
        </div>

        {% if user_message %}
        <div class="message-history">
            <p>あなた: {{ user_message }}</p>
            <p style="white-space: pre-wrap;">Bot: {{ bot_reply }}</p>
        </div>
        {% endif %}
    </div>

    <script>
        // ボタンのデータを配列で定義
        const buttonsData = [
            { latex: '\\frac{}{}', image: '\\frac{\\square}{\\square}', title: '分数' },
            { latex: '{}^{n}', image: '\\square^n', title: '上付き文字' },
            { latex: '{}_{n}', image: '\\square_n', title: '下付き文字' },
            { latex: '\\sqrt{}', image: '\\sqrt{\\square}', title: '平方根' },
            { latex: '\\sqrt[n]{}', image: '\\sqrt[n]{\\square}', title: 'n乗根' },
            { latex: '\\pi', image: '\\pi', title: '円周率' },
            { latex: 'e', image: 'e', title: 'ネイピア数' },
            { latex: 'e^{}', image: 'e^\\square', title: 'eのべき乗' },
            { latex: '\\ln()', image: '\\ln(\\square)', title: '自然対数' },
            { latex: '\\log_{n}()', image: '\\log_{n}(\\square)', title: '底を指定した対数' },
            { latex: '\\log_{10}()', image: '\\log_{10}(\\square)', title: '常用対数' },
            { latex: '|{}|', image: '|\\square|', title: '絶対値' },
            { latex: '\\frac{d}{d{}}() ', image: '\\frac{d}{d\\square}(\\square)', title: '微分' },
            { latex: '\\frac{d^2}{d{}^2}() ', image: '\\frac{d^2}{d\\square^2}(\\square)', title: '2階微分' },
            { latex: '\\frac{\\partial}{\\partial{}}() ', image: '\\frac{\\partial}{\\partial \\square}(\\square)', title: '偏微分' },
            { latex: '\\frac{\\partial^2}{\\partial{}^2}() ', image: '\\frac{\\partial^2}{\\partial \\square^2}(\\square)', title: '2階偏微分' },
            { latex: '\\frac{\\partial^2}{\\partial{}\\partial{}}() ', image: '\\frac{\\partial^2}{\\partial \\square \\partial \\square}(\\square)', title: '2変数2階偏微分' },
            { latex: '\\int () d ', image: '\\int \\square d\\square', title: '積分' },
            { latex: '\\iint () d d ', image: '\\iint \\square d\\square d\\square', title: '重積分' },
            { latex: '\\iiint () d d d ', image: '\\iiint \\square d\\square d\\square d\\square', title: '3重積分' },
            { latex: '\\int_{}^{} d ', image: '\\int_{\\square}^{\\square}\\square d\\square ', title: '定積分' },
            { latex: '\\int_{}^{} \\int_{}^{} () d d ', image: '\\int_{\\square}^{\\square}\\int_{\\square}^{\\square}\\square d\\square d\\square', title: '重定積分' },
            { latex: '\\int_{}^{} \\int_{}^{} \\int_{}^{} () d d d ', image: '\\int_{\\square}^{\\square}\\int_{\\square}^{\\square}\\int_{\\square}^{\\square}\\square d\\square d\\square d\\square', title: '3重定積分' },
            { latex: '\\sum_{}^{}() ', image: '\\sum_{\\square}^{\\square}\\square', title: '総和' },
            { latex: '\\prod_{}^{}() ', image: '\\prod_{\\square}^{\\square}\\square', title: '総乗' },
        ];

        // ボタンを生成して挿入する関数
        function createButtons(buttonsData) {
            const buttonContainer = document.getElementById('button-container');

            buttonsData.forEach(button => {
                const buttonElement = document.createElement('button');
                buttonElement.className = 'op-button';
                buttonElement.onclick = () => insertOperator(button.latex + ' '); // 末尾にスペースを追加

                const imgElement = document.createElement('img');
                imgElement.src = `https://latex.codecogs.com/svg.latex?${button.image}`;
                imgElement.title = `${button.title} (${button.latex})`;
                imgElement.height = 24;

                buttonElement.appendChild(imgElement);
                buttonContainer.appendChild(buttonElement);
            });
        }

        // ページ読み込み時にボタンを生成
        window.onload = () => {
            createButtons(buttonsData);
        };

        // 演算子を挿入する関数（以前と同じ）
        function insertOperator(operator) {
            const inputField = document.getElementById('user_message');
            const start = inputField.selectionStart;
            const end = inputField.selectionEnd;
            const value = inputField.value;
            inputField.value = value.substring(0, start) + operator + value.substring(end);
            inputField.selectionStart = inputField.selectionEnd = start + operator.length;
            inputField.focus();
        }

        document.getElementById('user_message').addEventListener('input', function() {
            const input = this.value;
            const preview = document.getElementById('preview');
            preview.innerHTML = '$$' + input + '$$';
            MathJax.typesetPromise([preview]).catch((err) => console.log(err));
        });
    </script>
</body>

{% endblock %}